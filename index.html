<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Controle de empr√©stimos - Boldt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { black: '#000000', blue: '#0033CC', navy: '#0a192f', gray: '#F8F9FB', light: '#FFFFFF', accent: '#3b82f6' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #F8F9FB; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .custom-input { transition: all 0.2s ease; border: 1.5px solid #edf2f7; outline: none; background-color: #ffffff; }
        .custom-input:focus { border-color: #0033CC; ring: 3px; ring-color: rgba(0, 51, 204, 0.08); background-color: #fff; }
        .modal-bg { background-color: rgba(0,0,0,0.6); backdrop-filter: blur(8px); }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
        .btn-hover { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-hover:hover { transform: translateY(-1px); filter: brightness(110%); }
        .btn-hover:active { transform: translateY(0px); }
    </style>
</head>
<body class="text-brand-navy flex flex-col min-h-screen">

    <!-- CONFIGURA√á√ÉO API -->
    <div id="configModal" class="fixed inset-0 modal-bg z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-md p-8 shadow-2xl fade-in text-center">
            <div class="w-16 h-16 bg-blue-50 text-brand-blue rounded-2xl flex items-center justify-center mx-auto mb-6 text-2xl">
                <i class="fa-solid fa-link"></i>
            </div>
            <h3 class="text-xl font-extrabold mb-2 uppercase tracking-tight">Conectividade</h3>
            <p class="text-gray-500 text-sm mb-6">Insira a URL do seu Google Apps Script para sincronizar os dados.</p>
            <div class="text-left space-y-2 mb-6">
                <label class="text-[10px] font-black uppercase text-gray-400 tracking-widest ml-1">Endpoint do Script</label>
                <textarea id="apiUrlInput" rows="3" class="custom-input w-full px-4 py-3 rounded-xl bg-gray-50 text-xs font-medium" placeholder="https://script.google.com/..."></textarea>
            </div>
            <button onclick="saveConfig()" class="w-full bg-brand-blue text-white py-4 rounded-2xl font-bold uppercase text-xs tracking-widest btn-hover shadow-lg shadow-blue-200">Salvar Endpoint</button>
            <button onclick="closeModal('configModal')" class="mt-4 text-gray-400 text-[10px] font-bold uppercase tracking-widest hover:text-gray-600 transition-colors">Fechar</button>
        </div>
    </div>

    <!-- MODAL: EDITAR -->
    <div id="editModal" class="fixed inset-0 modal-bg z-[80] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-md p-8 shadow-2xl fade-in relative">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h3 class="text-xl font-black uppercase tracking-tighter">Ajustar Contrato</h3>
                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Modificar par√¢metros iniciais</p>
                </div>
                <button onclick="closeModal('editModal')" class="w-10 h-10 rounded-full bg-gray-50 text-gray-400 hover:bg-gray-100 transition-all flex items-center justify-center"><i class="fa-solid fa-times"></i></button>
            </div>
            <form id="editForm" class="space-y-6">
                <input type="hidden" id="editId">
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-gray-400 ml-1 tracking-widest">Titular da Conta</label>
                    <input type="text" id="editName" required class="custom-input w-full px-5 py-4 rounded-2xl font-bold text-sm">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-gray-400 ml-1 tracking-widest">Montante Inicial</label>
                        <input type="number" id="editAmount" step="0.01" required class="custom-input w-full px-5 py-4 rounded-2xl font-black text-sm text-brand-blue">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-gray-400 ml-1 tracking-widest">Taxa de Juros (%)</label>
                        <input type="number" id="editRate" step="0.1" required class="custom-input w-full px-5 py-4 rounded-2xl font-black text-sm">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-gray-400 ml-1 tracking-widest">Data de In√≠cio</label>
                        <input type="date" id="editStart" required class="custom-input w-full px-4 py-4 rounded-2xl text-xs font-bold">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-gray-400 ml-1 tracking-widest">Data de Vencimento</label>
                        <input type="date" id="editPay" required class="custom-input w-full px-4 py-4 rounded-2xl text-xs font-bold">
                    </div>
                </div>
                <button type="submit" class="w-full bg-brand-blue text-white py-5 rounded-2xl font-black uppercase text-xs tracking-widest btn-hover shadow-xl shadow-blue-200">Guardar Altera√ß√µes</button>
            </form>
        </div>
    </div>

    <!-- MODAL: BAIXA -->
    <div id="partialModal" class="fixed inset-0 modal-bg z-[80] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-8 shadow-2xl fade-in relative text-center">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-black uppercase tracking-tighter">Registar Recebimento</h3>
                <button onclick="closeModal('partialModal')" class="text-gray-400 hover:text-black transition-colors"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="bg-blue-50/50 p-6 rounded-3xl mb-8 border border-blue-100/50">
                <p class="text-[9px] text-blue-800 uppercase font-black mb-1 tracking-widest opacity-60">D√≠vida Total Contratada</p>
                <p id="partialTotalInitial" class="text-3xl font-black text-brand-blue tracking-tighter">R$ 0,00</p>
                <div id="partialPaidBadge" class="mt-3 inline-flex items-center gap-2 px-4 py-1.5 bg-white rounded-full text-[10px] font-extrabold text-emerald-600 border border-emerald-100 shadow-sm uppercase tracking-tight italic">
                    <i class="fa-solid fa-circle-check text-[8px]"></i> J√° recebido: R$ 0,00
                </div>
            </div>

            <form id="partialForm" class="space-y-6 text-left">
                <input type="hidden" id="partialId">
                <div class="grid grid-cols-1 gap-5">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-gray-400 ml-1 tracking-widest">Data do Pagamento</label>
                        <input type="date" id="partialDate" required class="custom-input w-full px-4 py-4 rounded-2xl text-xs font-bold">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-gray-400 ml-1 tracking-widest">Valor do Recebimento (R$)</label>
                        <input type="number" id="partialAmount" step="0.01" placeholder="0,00" required class="custom-input w-full px-5 py-5 rounded-2xl text-2xl font-black text-brand-blue shadow-inner">
                    </div>
                </div>
                <button type="submit" class="w-full bg-brand-blue text-white py-5 rounded-2xl font-black uppercase text-xs tracking-widest btn-hover shadow-xl shadow-blue-100 mt-2">Confirmar Baixa</button>
            </form>
        </div>
    </div>

    <!-- LOGIN -->
    <div id="loginScreen" class="fixed inset-0 bg-brand-black z-[200] flex items-center justify-center p-6 text-center">
        <div class="w-full max-w-xl">
            <div class="w-20 h-20 bg-brand-blue text-white rounded-3xl flex items-center justify-center mx-auto mb-10 text-3xl shadow-2xl shadow-blue-900/40 rotate-3">
                <i class="fa-solid fa-vault"></i>
            </div>
            <h1 class="text-4xl md:text-5xl font-black text-white mb-10 tracking-tighter uppercase italic">Controle de empr√©stimos - Boldt</h1>
            
            <form onsubmit="event.preventDefault(); checkLogin();" class="max-w-xs mx-auto space-y-4">
                <div class="relative group">
                    <input type="password" id="passwordInput" placeholder="Chave de Acesso" class="w-full bg-white/5 text-center text-white rounded-3xl py-6 border border-white/10 outline-none focus:border-brand-blue focus:bg-white/10 transition-all font-bold tracking-widest text-lg">
                </div>
                <button type="submit" class="w-full bg-brand-blue text-white py-5 rounded-3xl font-black uppercase tracking-widest hover:brightness-110 active:scale-95 transition-all">Entrar</button>
            </form>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="appContent" class="hidden flex-col min-h-screen">
        <nav class="bg-white border-b border-gray-100 p-5 flex justify-between items-center sticky top-0 z-40 backdrop-blur-lg bg-white/80">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-brand-black text-white rounded-xl flex items-center justify-center shadow-lg shadow-gray-200">
                    <i class="fa-solid fa-b text-sm font-black italic"></i>
                </div>
                <div class="font-black tracking-tighter italic text-2xl uppercase">Controle Boldt</div>
            </div>
            <div class="flex gap-3">
                <button onclick="openConfig()" class="w-11 h-11 rounded-2xl bg-gray-50 flex items-center justify-center text-gray-400 hover:text-brand-blue hover:bg-blue-50 transition-all border border-gray-100 shadow-sm"><i class="fa-solid fa-sliders text-sm"></i></button>
                <button onclick="logout()" class="w-11 h-11 rounded-2xl bg-gray-50 flex items-center justify-center text-black hover:bg-black hover:text-white transition-all border border-gray-100 shadow-sm"><i class="fa-solid fa-power-off text-sm"></i></button>
            </div>
        </nav>

        <main class="p-6 md:p-10 container mx-auto max-w-7xl">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
                
                <!-- COLUNA LAN√áAMENTO -->
                <div class="lg:col-span-4">
                    <div class="bg-white p-8 rounded-[2.5rem] card-shadow border border-gray-100 sticky top-32">
                        <div class="flex items-center gap-3 mb-8">
                            <div class="w-8 h-8 bg-black rounded-lg flex items-center justify-center text-white text-xs">
                                <i class="fa-solid fa-plus"></i>
                            </div>
                            <h3 class="text-xs font-black uppercase tracking-[0.2em] text-gray-400">Novo Contrato</h3>
                        </div>
                        
                        <form id="debtForm" class="space-y-6">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black uppercase text-gray-400 ml-1 tracking-widest">Identifica√ß√£o do Cliente</label>
                                <input type="text" id="name" placeholder="Nome Completo" required class="custom-input w-full px-5 py-4 rounded-2xl font-bold text-sm">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black uppercase text-gray-400 ml-1 tracking-widest">Montante Inicial</label>
                                    <input type="number" id="amount" step="0.01" placeholder="R$ 0,00" required class="custom-input w-full px-5 py-4 rounded-2xl font-black text-sm text-brand-blue">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black uppercase text-gray-400 ml-1 tracking-widest">Juros (%)</label>
                                    <input type="number" id="rate" placeholder="7" value="7" required class="custom-input w-full px-5 py-4 rounded-2xl font-black text-sm">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black uppercase text-gray-400 ml-1 tracking-widest">Data Inicial</label>
                                    <input type="date" id="startDate" required class="custom-input w-full px-4 py-4 rounded-2xl text-xs font-bold">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black uppercase text-gray-400 ml-1 tracking-widest">Vencimento</label>
                                    <input type="date" id="payDate" required class="custom-input w-full px-4 py-4 rounded-2xl text-xs font-bold">
                                </div>
                            </div>
                            
                            <button type="submit" class="w-full bg-brand-blue text-white py-5 rounded-2xl font-black uppercase text-xs tracking-widest shadow-xl shadow-blue-200 btn-hover mt-4">
                                Ativar Empr√©stimo
                            </button>
                        </form>
                    </div>
                </div>

                <!-- COLUNA LISTAGEM -->
                <div class="lg:col-span-8">
                    <!-- CART√ïES DE RESUMO -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                        <div class="bg-white p-8 rounded-[2rem] card-shadow border-l-[6px] border-brand-blue">
                            <span class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 block mb-2">Pendente Geral</span>
                            <div id="displayPending" class="text-4xl font-black text-brand-blue tracking-tighter">R$ 0,00</div>
                        </div>
                        <div class="bg-white p-8 rounded-[2rem] card-shadow border-l-[6px] border-red-500">
                            <span class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 block mb-2">Vencidos Hoje</span>
                            <div id="displayOverdue" class="text-4xl font-black text-red-500 tracking-tighter">R$ 0,00</div>
                        </div>
                        <div class="bg-emerald-500 p-8 rounded-[2rem] shadow-xl shadow-emerald-200 text-white">
                            <span class="text-[10px] font-black uppercase tracking-[0.2em] text-emerald-100 block mb-2">Total Recebido</span>
                            <div id="displayProfit" class="text-4xl font-black tracking-tighter">R$ 0,00</div>
                        </div>
                    </div>

                    <!-- TABELA DE CONTRATOS -->
                    <div class="bg-white rounded-[2.5rem] card-shadow overflow-hidden border border-gray-50">
                        <div class="p-8 border-b border-gray-50 flex justify-between items-center bg-gray-50/30">
                            <div class="flex items-center gap-3">
                                <div class="w-2 h-6 bg-brand-blue rounded-full"></div>
                                <h3 class="text-xs font-black uppercase tracking-widest text-gray-500">Contratos na Carteira</h3>
                            </div>
                            <button onclick="setStatusFilter('pending')" id="chip-pending" class="text-[9px] font-black uppercase px-6 py-3 rounded-2xl bg-white border border-gray-200 text-gray-400 transition-all hover:bg-gray-100 active:scale-95 shadow-sm">Somente Abertos</button>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-white text-[10px] uppercase font-black text-gray-400 tracking-widest">
                                    <tr>
                                        <th class="px-8 py-6">Benefici√°rio</th>
                                        <th class="px-8 py-6 text-right">Saldo Atualizado</th>
                                        <th class="px-8 py-6 text-center">Opera√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="debtTableBody" class="divide-y divide-gray-50"></tbody>
                            </table>
                        </div>
                        
                        <div id="emptyState" class="hidden py-32 text-center fade-in">
                            <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-200 text-2xl">
                                <i class="fa-solid fa-folder-open"></i>
                            </div>
                            <p class="text-gray-300 font-black uppercase text-xs tracking-widest">Nenhum contrato ativo encontrado</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- LOADER -->
    <div id="globalLoader" class="fixed inset-0 bg-white/95 z-[300] hidden flex flex-col items-center justify-center backdrop-blur-md">
        <div class="w-16 h-16 border-[6px] border-gray-100 border-t-brand-blue rounded-full animate-spin shadow-inner"></div>
        <p class="mt-6 text-[10px] font-black text-gray-300 uppercase tracking-[0.5em] animate-pulse">Sincronizando Sistema</p>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyOmwn-cCmdnJNPD3qcpqPqPhrWb4CKq7je79FSdyIh8pLKcBiV-uck-MT2bW1ix8U64w/exec";
        let debts = [];
        let statusFilter = 'all';

        function getApi() { return localStorage.getItem('boldt_api_url') || API_URL; }
        function saveConfig() { const u = document.getElementById('apiUrlInput').value.trim(); if(u){ localStorage.setItem('boldt_api_url', u); location.reload(); }}
        function openConfig() { document.getElementById('apiUrlInput').value = getApi(); document.getElementById('configModal').classList.remove('hidden'); }
        function showLoader(v) { document.getElementById('globalLoader').classList.toggle('hidden', !v); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        function checkLogin() {
            if (document.getElementById('passwordInput').value === 'boldt') {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appContent').classList.remove('hidden');
                document.getElementById('appContent').classList.add('flex');
                localStorage.setItem('boldt_session', 'active');
                init();
            } else {
                const input = document.getElementById('passwordInput');
                input.classList.add('border-red-500', 'bg-red-500/10');
                setTimeout(() => input.classList.remove('border-red-500', 'bg-red-500/10'), 1000);
            }
        }
        if (localStorage.getItem('boldt_session') === 'active') {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContent').classList.remove('hidden');
            document.getElementById('appContent').classList.add('flex');
            init();
        }

        function init() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('payDate').value = today;
            load();
        }

        async function load() {
            showLoader(true);
            try {
                const res = await fetch(`${getApi()}?t=${Date.now()}`);
                const data = await res.json();
                if (Array.isArray(data)) debts = data;
                render();
            } catch (e) { console.error(e); } finally { showLoader(false); }
        }

        async function action(payload) {
            showLoader(true);
            try {
                await fetch(getApi(), { 
                    method: 'POST', 
                    redirect: "follow",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload) 
                });
                closeModal('editModal');
                closeModal('partialModal');
                setTimeout(load, 1500);
            } catch (e) { alert("Erro de comunica√ß√£o com o servidor."); showLoader(false); }
        }

        document.getElementById('debtForm').addEventListener('submit', e => {
            e.preventDefault();
            action({ action: 'create', data: { name: document.getElementById('name').value, amount: Number(document.getElementById('amount').value), rate: Number(document.getElementById('rate').value), startDate: document.getElementById('startDate').value, payDate: document.getElementById('payDate').value, id: 'ID'+Date.now(), status: 'pending' } });
            e.target.reset();
        });

        window.deleteItem = (id) => { if(confirm("Eliminar este contrato definitivamente? Esta a√ß√£o n√£o pode ser revertida.")) action({ action: 'delete', id: String(id) }); };

        window.openEdit = (id) => {
            const d = debts.find(x => String(x.id) === String(id));
            if(!d) return;
            document.getElementById('editId').value = d.id;
            document.getElementById('editName').value = d.name;
            document.getElementById('editAmount').value = Number(d.amount);
            document.getElementById('editRate').value = Number(d.rate);
            document.getElementById('editStart').value = d.startDate.split('T')[0];
            document.getElementById('editPay').value = d.payDate.split('T')[0];
            document.getElementById('editModal').classList.remove('hidden');
        };

        document.getElementById('editForm').addEventListener('submit', e => {
            e.preventDefault();
            action({ action: 'update', data: { id: document.getElementById('editId').value, name: document.getElementById('editName').value, amount: Number(document.getElementById('editAmount').value), rate: Number(document.getElementById('rate').value), startDate: document.getElementById('editStart').value, payDate: document.getElementById('editPay').value } });
        });

        window.openPartial = (id) => {
            const d = debts.find(x => String(x.id) === String(id));
            if(!d) return;
            document.getElementById('partialId').value = d.id;
            const data = getStaticData(d);
            document.getElementById('partialTotalInitial').innerText = formatMoney(data.initialTotal);
            document.getElementById('partialPaidBadge').innerText = `J√° recebido: ${formatMoney(data.paidTotal)}`;
            document.getElementById('partialDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('partialAmount').value = '';
            document.getElementById('partialModal').classList.remove('hidden');
        };

        document.getElementById('partialForm').addEventListener('submit', e => {
            e.preventDefault();
            action({ action: 'partial', id: document.getElementById('partialId').value, value: Number(document.getElementById('partialAmount').value), date: document.getElementById('partialDate').value });
        });

        window.updateStatus = (id, s) => action({ action: 'updateStatus', id, status: s === 'paid' ? 'pending' : 'paid' });

        function formatMoney(v) { return Number(v).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}); }
        function formatDate(s) { if(!s) return '-'; const p = s.split('T')[0].split('-'); return `${p[2]}/${p[1]}/${p[0]}`; }

        function setStatusFilter(s) {
            statusFilter = s === statusFilter ? 'all' : s;
            const btn = document.getElementById('chip-pending');
            btn.classList.toggle('bg-brand-blue', statusFilter === 'pending');
            btn.classList.toggle('text-white', statusFilter === 'pending');
            render();
        }

        function getStaticData(d) {
            const P = Number(d.amount); 
            const R = Number(d.rate) / 100;
            const start = new Date(d.startDate.split('T')[0] + "T12:00:00");
            const end = new Date(d.payDate.split('T')[0] + "T12:00:00");
            const M = Math.max(0, (end - start) / (1000 * 60 * 60 * 24 * 30));
            
            const JurosOriginal = P * R * M;
            const TotalInicialContratado = P + JurosOriginal;
            
            let hist = [];
            try { hist = JSON.parse(d.history || "[]"); } catch(e){}
            const TotalAmortizado = hist.reduce((acc, h) => acc + Number(h.value), 0);
            
            return {
                initialTotal: TotalInicialContratado,
                paidTotal: TotalAmortizado,
                currentBalance: Math.max(0, TotalInicialContratado - TotalAmortizado),
                p_original: P,
                j_original: JurosOriginal
            };
        }

        function getWhatsappLink(d) {
            const data = getStaticData(d);
            const text = `Ol%C3%A1%20*${encodeURIComponent(d.name)}*,%20extrato%20Controle%20Boldt:%0Aüìå%20*D√≠vida%20Inicial:*%20${formatMoney(data.initialTotal)}%0A‚úÖ%20*Total%20Pago:*%20${formatMoney(data.paidTotal)}%0Aüí∞%20*Saldo%20Devedor:*%20${formatMoney(data.currentBalance)}`;
            return `https://wa.me/?text=${text}`;
        }

        function render() {
            const tbody = document.getElementById('debtTableBody');
            tbody.innerHTML = '';
            let pendingSum = 0, overdueSum = 0, profitSum = 0;

            debts.forEach(d => {
                const data = getStaticData(d);
                profitSum += data.paidTotal;

                if (statusFilter === 'pending' && d.status === 'paid') return;
                
                const isPaid = d.status === 'paid';
                const venc = new Date(d.payDate.split('T')[0] + "T12:00:00");
                const isOver = !isPaid && venc < (new Date().setHours(0,0,0,0));

                if (!isPaid) { 
                    pendingSum += data.currentBalance; 
                    if (isOver) overdueSum += data.currentBalance; 
                }

                const tr = document.createElement('tr');
                tr.className = "group hover:bg-gray-50/50 border-b border-gray-50 transition-all fade-in";
                tr.innerHTML = `
                    <td class="px-8 py-6">
                        <div class="font-bold text-sm ${isPaid ? 'text-gray-300' : 'text-brand-navy'}">${d.name}</div>
                        <div class="text-[9px] uppercase font-black text-gray-400 mt-1 tracking-tighter italic">Vencimento: ${formatDate(d.payDate)}</div>
                    </td>
                    <td class="px-8 py-6 text-right">
                        <div class="font-black text-lg ${isPaid ? 'text-gray-300' : (isOver ? 'text-red-500' : 'text-brand-blue')} tracking-tight">${formatMoney(data.currentBalance)}</div>
                        ${!isPaid ? `<div class="text-[8px] text-gray-300 uppercase font-black mt-1">Acordado: ${formatMoney(data.initialTotal)}</div>` : ''}
                    </td>
                    <td class="px-8 py-6 text-center">
                        <div class="flex items-center justify-center gap-1.5 opacity-10 md:opacity-0 group-hover:opacity-100 transition-all">
                            <a href="${getWhatsappLink(d)}" target="_blank" class="w-10 h-10 rounded-2xl bg-gray-50 text-emerald-500 hover:bg-emerald-500 hover:text-white flex items-center justify-center transition-all shadow-sm border border-gray-100"><i class="fa-brands fa-whatsapp"></i></a>
                            <button onclick="openPartial('${d.id}')" class="w-10 h-10 rounded-2xl bg-gray-50 text-brand-blue hover:bg-brand-blue hover:text-white transition-all shadow-sm border border-gray-100"><i class="fa-solid fa-hand-holding-dollar"></i></button>
                            <button onclick="openEdit('${d.id}')" class="w-10 h-10 rounded-2xl bg-gray-50 text-gray-400 hover:bg-black hover:text-white transition-all shadow-sm border border-gray-100"><i class="fa-solid fa-pen-nib text-[10px]"></i></button>
                            <button onclick="updateStatus('${d.id}', '${d.status}')" class="w-10 h-10 rounded-2xl bg-gray-50 ${isPaid ? 'text-black' : 'text-gray-300'} hover:bg-black hover:text-white transition-all shadow-sm border border-gray-100"><i class="fa-solid fa-check-double text-[10px]"></i></button>
                            <button onclick="deleteItem('${d.id}')" class="w-10 h-10 rounded-2xl bg-gray-50 text-red-300 hover:bg-red-500 hover:text-white transition-all shadow-sm border border-gray-100"><i class="fa-solid fa-trash-can text-[10px]"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('displayPending').innerText = formatMoney(pendingSum);
            document.getElementById('displayOverdue').innerText = formatMoney(overdueSum);
            document.getElementById('displayProfit').innerText = formatMoney(profitSum);
            document.getElementById('emptyState').classList.toggle('hidden', debts.length > 0);
        }
        function logout() { localStorage.removeItem('boldt_session'); location.reload(); }
    </script>
</body>
</html>
